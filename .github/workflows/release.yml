name: Build and Release APK

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up .NET
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '7.0.x'

      # https://blog.taranissoftware.com/build-net-maui-apps-with-github-actions
      - name: Install MAUI Workload
        run: dotnet workload install maui --ignore-failed-sources
        
      - name: Restore NuGet Packages
        run: dotnet restore

      # https://medium.com/@henningmosand/change-applicationversion-for-a-net-maui-in-github-action-1ee188a32671
      - name: Bump ApplicationVersion (build version)
        env:
          CSPROJ_FILE: YeetMacro2/YeetMacro2.csproj
          NEW_VERSION: ${{ github.run_number }}
        run: |
          echo 'Setting ApplicationVersion (build version) to ${{ env.NEW_VERSION }}'
          sed -rn 's|(<ApplicationVersion>)(.*)(</ApplicationVersion>)|Old: \1\2\3|p' ${{ env.CSPROJ_FILE }}
          sed -rE -i 'notneeded.bak' 's|(<ApplicationVersion>)(.*)(</ApplicationVersion>)|<ApplicationVersion>${{ env.NEW_VERSION }}</ApplicationVersion>|g' ${{ env.CSPROJ_FILE }}
          sed -rn 's|(<ApplicationVersion>)(.*)(</ApplicationVersion>)|New: \1\2\3|p' ${{ env.CSPROJ_FILE }}
          sed -rn 's|(<ApplicationDisplayVersion>)(.*)(</ApplicationDisplayVersion>)|Old: \1\2\3|p' ${{ env.CSPROJ_FILE }}
          sed -rE -i 'notneeded2.bak' 's|(<ApplicationDisplayVersion>)(.*)(</ApplicationDisplayVersion>)|<ApplicationDisplayVersion>${{ env.NEW_VERSION }}</ApplicationDisplayVersion>|g' ${{ env.CSPROJ_FILE }}
          sed -rn 's|(<ApplicationDisplayVersion>)(.*)(</ApplicationDisplayVersion>)|New: \1\2\3|p' ${{ env.CSPROJ_FILE }}
      - name: Build APK
        run: dotnet build -f net7.0-android -c Release

     #- name: Upload APK as Release Asset
     #  uses: actions/upload-artifact@v1
     #  with:
     #    name: app-release
     #    path: YeetMacro2/bin/Release/net7.0-android/com.companyname.yeetmacro2-Signed.apk
      
      # https://github.com/softprops/action-gh-release
      - name: Attach Asset to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "latest"
          files: YeetMacro2/bin/Release/net7.0-android/com.companyname.yeetmacro2-Signed.apk